"""
Creates TSV and LBL manifest files for the fairseq-based ECG foundation model.

Reads the labels CSV generated by `ecg_labels.py` and formats the data into
the specific manifest structure expected by `fairseq_signals` / `ecg-fm`.
The files map each patient's `<subject_id>.mat` file to its sepsis target label.

Usage:
    python -m src.data.preprocess.ecg.create_manifests
"""

import logging
import pandas as pd
from pathlib import Path

from src.utils.config import Config

logger = logging.getLogger(__name__)

# --- CONFIG ---
MAT_DIR = Config.ECG_PROCESSED_ROOT_DIR / "preprocessed"
OUTPUT_DIR = Config.ECG_MANIFEST_DIR
SQL_CSV = Config.ECG_LABELS_DIR / "labels.csv"

SAMPLE_RATE = 500
DURATION = 10
N_FRAMES = SAMPLE_RATE * DURATION  # 5000 frames for 10s MIMIC-IV-ECGs


def main():
    Config.setup_logging()
    logger.info("Starting manifest creation for fairseq_signals...")

    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    if not SQL_CSV.exists():
        logger.error(
            "Labels CSV not found at %s. Please run ecg_labels.py first.", SQL_CSV
        )
        return

    logger.info("Loading labels from %s", SQL_CSV)
    df = pd.read_csv(SQL_CSV)

    # Map SQL 'split' values to fairseq names
    split_map = {"train": "train", "validate": "valid", "test": "test"}

    manifest_count = 0
    for sql_split, fairseq_split in split_map.items():
        subset = df[df["split"] == sql_split]

        if len(subset) == 0:
            logger.warning("No records found for split: %s", sql_split)
            continue

        tsv_path = OUTPUT_DIR / f"{fairseq_split}.tsv"
        lbl_path = OUTPUT_DIR / f"{fairseq_split}.lbl"

        logger.info(
            "Creating manifests for %s split (%d records)...",
            fairseq_split,
            len(subset),
        )

        with open(tsv_path, "w") as f_tsv, open(lbl_path, "w") as f_lbl:
            # TSV Header: Absolute root directory for the waveform files
            f_tsv.write(f"{MAT_DIR}\n")

            for _, row in subset.iterrows():
                # Filename strictly uses subject_id due to earlier pipeline changes.
                # Cast to int to prevent Pandas from formatting it as a float (e.g., 12345.0.mat)
                fname = f"{int(row['sample_id'])}.mat"

                # Write to TSV: relative_path \t n_frames
                f_tsv.write(f"{fname}\t{N_FRAMES}\n")

                # Write to LBL: The target label
                f_lbl.write(f"{int(row['label'])}\n")

        manifest_count += 1

    logger.info(
        "Successfully created %d sets of manifests in %s", manifest_count, OUTPUT_DIR
    )


if __name__ == "__main__":
    main()
