"""
Processes full-length ECG waveform signals for the MIMIC-IV-ECG dataset.

This script utilizes the `fairseq_signals` library to read raw WFDB files,
apply resampling to a standard frequency (500 Hz), and perform z-score normalization.
It deliberately skips segmentation to preserve the entire ECG waveform (typically 10s)
for whole-ECG downstream classification.

The preprocessed signals are saved as `.mat` files, named by `subject_id`
to maintain alignment with the EHR embeddings during late fusion.

Usage:
    python -m src.data.preprocess.ecg.signals
"""

import logging
import pandas as pd
from pathlib import Path

from fairseq_signals_scripts.preprocess.ecg.preprocess import (
    pipeline,
    postprocess_wfdb,
)
from src.utils.config import Config

SOURCE = "mimic_iv_ecg"
logger = logging.getLogger(__name__)


class MockArgs:
    """A simple class to mimic the structure of argparse results."""

    def __init__(self):
        self.raw_root = Config.RAW_ECG_DIR
        self.processed_root = Config.ECG_PROCESSED_ROOT_DIR

        # Preserving whole-ECG logic
        self.skip = "segmented"
        self.segment_seconds = None

        self.manifest_file = None
        self.results_suffix = ""
        self.dataset_subset = None
        self.no_parallel = False
        self.nb_workers = 8
        self.no_standardization = False  # Ensures Z-score normalization is applied
        self.leads = [str(i) for i in range(12)]
        self.constant_lead_strategy = "zero"
        self.desired_sample_rate = 500


def postprocess_meta(meta: pd.DataFrame):
    """Clean up unnecessary columns before finalizing metadata."""
    meta = meta.drop(["comments", "base_date", "base_time"], axis=1)
    return postprocess_wfdb(meta)


def main():
    Config.setup_logging()
    logger.info("Starting ECG waveform preprocessing...")

    args = MockArgs()

    # Safely load the records generated by records.py
    records_csv_path = args.processed_root / "records.csv"
    logger.info("Loading records from: %s", records_csv_path)
    records = pd.read_csv(records_csv_path)

    # Safely construct full paths for the waveforms
    records["path"] = records["path"].apply(lambda p: str(args.raw_root / p))

    # Save using subject_id to align with EHR modalities for late fusion
    records["save_file"] = records["subject_id"].astype(str) + ".mat"
    logger.info("Mapped save files to subject_id.")

    records["source"] = SOURCE
    records["dataset"] = SOURCE

    # Convert roots to strings here as fairseq_signals expects string paths
    args.raw_root = str(args.raw_root)
    args.processed_root = str(args.processed_root)

    logger.info("Initiating fairseq_signals pipeline...")
    pipeline(
        args,
        records,
        SOURCE,
        postprocess_extraction={"meta": postprocess_meta},
    )
    logger.info("ECG waveform preprocessing complete.")


if __name__ == "__main__":
    main()
